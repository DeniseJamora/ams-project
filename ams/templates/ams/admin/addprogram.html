{% extends 'base.html' %}
{% block content %}
    <!--START OF CONTENT-->
    <div class="container-fluid">
        <div class="animated fadeIn">
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header">
                            <strong>Add Degree Program</strong>
                        </div>
                        <form method="POST">
                            {% csrf_token %}
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <i><label for="pName">Program Name</label></i>
                                            {{ form.program_name }}
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <i><label for="pCode">Program Code</label></i>
                                            {{ form.program_code }}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <i><label for="pStartDate">Year Established</label></i>
                                            {{ form.program_est }}
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <i><label for="pGraduates">No of years with graduates</label></i>
                                            {{ form.program_grads }}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <i><label for="name">Previous Accreditations</label></i>
                                            <select class="form-control" name="prev_acc">
                                                <option>Please Select</option>
                                                <option>Yes</option>
                                                <option>No</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>


                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <button class="btn btn-success" type="button"
                                                    onclick="addAccreditationField()">
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                </div>


                                <div class="row">
                                    <div class="col-12 p-0" id="inputs">
                                        <div class="d-inline-block text-center col-sm-3 p-0">
                                            Agency
                                        </div>
                                        <div class="d-inline-block text-center col-sm-3 p-0">
                                            Level or Result
                                        </div>
                                        <div class="d-inline-block text-center col-sm-3 p-0">
                                            Year
                                        </div>
                                        <div class="d-inline-block text-center col-sm-1 p-0">

                                        </div>
                                    </div>


                                    <br><br>

                                    <div id="previous-accreditations-form" class="col-md-11">

                                    </div>
                                </div>


                            </div>


                            <div class="card-footer">
                                <button class="btn btn-primary" onclick="onSubmitButtonClick()">Add</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-none accreditation-form" id="master-accreditation-form">
        <div class="row p-2" id="inputs">
            <div class="col-sm-3">
                <input class="form-control agency-field" placeholder="Agency"/>
            </div>
            <div class="col-sm-3">
                <input class="form-control level-field" placeholder="Level or Result"/>
            </div>
            <div class="col-sm-3">
                <select class="form-control year-field">
                    <option id="master-option"></option>
                </select>
            </div>
            <div class="col-sm-1">
                <button class="btn btn-outline-danger remove-accreditation-button" type="button">Remove</button>
            </div>
        </div>
    </div>

    <script>
        $(() => {
            setUpMasterAccreditationForm();
            addAccreditationField();
        });

        function setUpMasterAccreditationForm() {
            const startYear = 1900;
            const endYear = new Date().getFullYear();

            let years = [];
            let counter = startYear;
            while (counter <= endYear) {
                years.push(counter);
                counter++;
            }

            const accreditationForm = $("#master-accreditation-form");
            const masterOption = $("#master-option");
            const yearField = accreditationForm.find("select.year-field");

            years
                .map(year => masterOption
                    .clone()
                    .removeAttr("id")
                    .val(year)
                    .html(year)
                )
                .forEach(year => yearField.prepend(year));


            masterOption.remove();
        }

        function onSubmitButtonClick() {
            const accreditationForms = collectAccreditationForms();
            console.log("Submitting");
            console.table(accreditationForms);
        }

        function collectAccreditationForms() {
            const accreditationForms = $("#previous-accreditations-form > div.accreditation-form");
            let accreditations = [];

            accreditationForms.each((idx, form) => {
                form = $(form);
                accreditations.push({
                    agency: form.find("input.agency-field").val(),
                    level: form.find("input.level-field").val(),
                    year: form.find("input.year-field").val()
                });
            });

            return accreditations;
        }


        function addAccreditationField() {
            const accreditationForm = $("#master-accreditation-form").clone();
            accreditationForm.removeAttr("id");
            accreditationForm.removeClass("d-none");

            accreditationForm.find("button.remove-accreditation-button").click(() => {
                accreditationForm.remove();
            });

            $("#previous-accreditations-form").prepend(accreditationForm);
        }


        var start = 1900;
        var end = new Date().getFullYear();
        var options = "";
        var a = "<option>Please Select Year</option>";
        for (var year = start; year <= end; year++) {
            options += "<option value='" + year + "'>" + year + "</option>";
        }
        document.getElementById("year").innerHTML = a + options;
    </script>
    <!--END OF CONTENT-->
{% endblock %}
